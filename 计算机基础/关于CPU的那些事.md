# :thumbsup:关于:computer:CPU的那些事

> 在寻求真理的长征中，唯有学习，不断地学习，勤奋地学习，有创造性的学习，才能越重山， 跨峻岭。 ——华罗庚

> 作为程序员，我们需要培养自己的技术领导力，而基础，是一切技术的根基。 ——lvan

## 概要

CPU是计算机组成里最重要的一个硬件了，我们编写程序的运行都离不开CPU，因此，对CPU的原理有个基本的认知，才知道该如何检查CPU，寻求性能优化的空间。

本篇文章主要是根据以下几个方面进行说明：

![img.png](../img/计算机基础/关于CPU的那些事.png)

## CPU是什么？

> [!NOTE]
> 我们所知道的CPU是中央处理器，那只是一个很表面的认知，这对编程没有任何帮助！

CPU是用来表示计算机内部元件功能的术语，CPU由具有ON/OFF开关功能的**晶体管**构成（也被称为IC（集成电路））。另外，有的CPU在一个集成电路中集成了两个CPU芯片，我们称之为双核CPU。

## CPU体系结构

从硬件来看，CPU是由许多的**晶体管**来构成的，**晶体管只有两个状态，就是开和关**，而触发晶体管的打开和关闭，则需要一个**晶体振荡器**来产生**时钟信号**，一个时钟信号在物理上对应着+0V ~ +5V电压的变更， 由于存在电压的高低变换，这种变换的电流就会触发晶体管的开和关，其实晶体管的开关状态，也就是对应这二进制的1和0。

从功能方面来看，CPU内部由寄存器、控制器、运算器和时钟四个部分构成，各部分之间由电流信号相互接通。

### 寄存器

不同类型的CPU、其内部寄存器的数量、种类以及寄存器存储的数量范围都是不同的。不过，根据功能，可以将寄存器分为以下几类：

- **累加寄存器：** 存储执行运算的数据和运算后的数据
- **标志寄存器：** 存储运算处理后的CPU的状态
- **程序计数器：** 存储下一条指令所在内存的地址
- **基址寄存器：** 存储数据内存的起始地址
- **变址寄存器：** 存储基址寄存器的相对地址
- **通用寄存器：** 存储任意数据
- **指令寄存器：** 存储指令，CPU内部使用，程序员无法通过程序对该寄存器进行读写操作
- **栈寄存器：** 存储栈区域的起始地址

### 控制器

控制器主要负责把内存上的指令、数据读入寄存器，并根据指令的执行结果来控制整个计算机。

### 运算器

运算器负责运算内存读入寄存器的数据。

### 时钟

时钟主要是负责产生信号，有些计算机的时钟是在外部的。我们可以通过查看计算机的属性信息来了解计算机的时钟频率，如我的笔记本处理器时钟为2.3GHz，
那么这个时钟周期的时间就是1/2.3GHz，可以简单理解为1秒内，CPU可以执行简单指令达到2.8G条。

从理论上来说，主频越高，CPU处理的指令就越多，性能也就越好。但事实并非如此，CPU执行的指令仍受限于流水线的设计。

## 程序是怎么运行的

> 我们编写的程序，到底是怎样运行起来的呢:question:
> 
> 这里牵扯的知识面还是比较多的，包括编译原理以及计算机组成原理，而这里仅仅是通俗地说下CPU如何运行程序，主要目的是理解CPU的寄存器、控制器、运算器的交互流程以及其作用。

编写完的程序需要翻译（需经过编译、链接、装载）成机器指令，翻译得到的机器指令将会存放到主存中（主存储器，简称主存，主要负责存储数据和指令），当程序启动后，根据时钟信号，控制器会从主存中读取指令和数据到寄存器中，控制器（cpu内部）会从主存中读取指令和数据到寄存器中，这里包括设置程序计数器来记录下一条指令的执行地址，然后CPU通过改变程序计数器的指令地址来选取下一条执行的指令，通过运算器来对寄存器中的数据进行运算，控制器则根据运算结果来控制计算机，如输出结果等。

## CPU处理器设计

### 指令周期、机器周期与时钟周期

**指令周期**

从整体来看，计算机是顺序执行指令的，更深入理解，计算机所执行的每一条指令，都要经过**取得指令**、**指令译码**、**执行指令**三个过程，那么计算机就是不断循环以上三个过程来执行指令的，单个循环周期，我们称之为**指令周期**。

一个指令周期每个步骤都会涉及到控制器、运算器以及寄存器，步骤细分说明如下：
- **取得指令**：程序启动时，CPU会从主存中加载数据和指令，并维护程序计算器的值，那么CPU从**程序计算器**可以读取到下一条指令的地址时，**控制器**会将指令地址上的指令加载到**指令寄存器**中，
  然后将程序计算器自增，以读取下一条指令。
- **指令译码**：根据寄存器里面的指令，进行解析，解析成要进行什么样的操作，属于哪一类别的指令，具体要操作哪些寄存器、数据或内存地址。
- **执行指令**：也就是运行译码后的指令，以进行算术逻辑操作、数据传输或者直接的地址跳转。

主存存储数据和指令，控制器负责**取得指令**，将指令读取到指令寄存器中，控制器再负责对指令寄存器中的指令进行译码，译码后的指令将由**算术逻辑单元（ALU）** 操作，也就是运算器处理。

**机器周期**

机器周期也称CPU周期，在计算机中，为了便于管理，常把一条指令的执行过程划分为多个阶段（如，取指令、指令译码、执行指令），每一个阶段完成一个基本操作。完成一个基本操作所需要的时间称为机器周期。

**时钟周期**

CPU的运行，需要依赖时钟不断地发出信号，那么每个信号的时间，我们称为时钟周期。

**指令周期、时钟周期与机器周期之间的关系：**

一个指令周期包括了多个机器周期，一个机器周期又包括了多个时钟周期。

**流水线设计**

一条指令的执行，至少需要花费一个时钟周期，这里先假设一个时钟周期正好可以处理一条指令，那么剩下的指令就需要排队处理了，这就是**单指令存储器**。

实际上，每一条指令的时钟周期是不一样的，有的指令执行的速度很快，有些则很慢，那么对于单指令存储器来说，为了保证每个指令的时钟周期一致，那么就只能将执行最慢的指令所需的时钟周期作为标准了，那么其他的指令提前执行完了，也需要继续等待时钟周期过去。

为了提升cpu处理的吞吐率，采用了**指令流水线技术**来进行优化。

现在我们都知道，一条指令的执行包括了取指令、指令译码、执行指令三个过程，那么在指令流水线设计中，将以上三个步骤中的执行步骤细分，还包括访存以及写回两个过程，也就是从寄存器或者内存中读书数据，通过ALU进行运算，把结果写回到寄存器或者内存中。

因此，已经不需要将时钟周期设置成整条指令执行的时间，而是拆分完这样的一个一个小步骤需要的时间，同时，每一个阶段的电路再完成对应的任务之后，也不需要等待整个指令执行完成，而是可以直接执行下一条指令的对应阶段——这就是指令流水线设计。

将一条指令拆分为取指令、指令译码、执行指令三个过程，那这就是一个**三级流水线**， 那再加上的访存、写回两个步骤时，那就称为一个**五级流水线**了。五级流水线如图：

![img.png](../img/计算机基础/五级指令流水线.png)

>[!warning]
>
>流水线等级越高，处理器的性能不一定会越高！

**结构冒险**

结构冒险，本质上是一个硬件层面的资源竞争的问题，也就是一个硬件电路层面的问题。

CPU在同一个时钟周期，同时在运行两条计算机指令的不同阶段。但是这两个不同的阶段，可能会用到同样的硬件电路，那么用到这些电路的指令就存在冲突的问题了。

问了解决指令冲突的问题，参考了**哈佛结构**的思路，现待的CPU虽然没有在内存层面进行对应得拆分，却在CPU内部得高速缓存部分进行了区分，把高速缓存分成了**指令缓存**与**数据缓存**两部分，以此解决硬件资源竞争的问题。

**数据冒险**

数据冒险，本质上是同时在执行多个指令之间，有数据依赖的情况。这些数据依赖，我们可以分成三个类，分别为先写后读、先读后写、写后再写，其实也就是下一个指令的执行会依赖上一个指令的执行结果，如果执行的顺序保证不了，那得到的运算结果就是错误的。

## CPU性能指标

## CPU性能监控实战

## CPU调优
