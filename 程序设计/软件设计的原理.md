# 软件设计的原理

> 如果一个人不知道他要驶向哪个码头，那么任何风都不会是顺风。——塞涅卡

## 思想

### 交流

代码也是一种给人看的文档，而文档的本质在于交流。

在编程中，良好的交流意味着读代码的人能够理解、修改和使用代码。

**How：**

要想通过代码取得良好的交流效果，我们在写代码时就得站在代码阅读者的角度思考。

### 简洁

对代码而言，简洁就是消除了“多余的复杂性”后的状态。这里所说的“多余的复杂性”不是指反映了目标（代码要达成的目的）复杂程度的复杂性，而是指在修改代码的过程中遗留下来的痕迹所带来的复杂性。

**How：**

要想让代码保持简洁，我们就需要将代码中的“玉”与“石”明确区分开来。在设计时，将代码的本质部分（玉）放在显眼的位置，保证其他元素（石）不会混入其中。

不过，简洁与交流偶尔也会发生冲突。过度简洁会使代码变得难以理解。在遇到这种情况时，我们就需要牺牲一部分简洁性，把交流放在优先的位置。

### 灵活性

代码的灵活性是指修改代码的难易程度。

“灵活”是指在添加新代码的时候，已有代码能够不受影响、不产生冲突、不出现排斥，在保证自身不遭到破坏的前提下灵活地接纳新代码。

**How：**

要想让代码具有灵活性，就要保证代码易于扩展且扩展时不会波及无关的元素。

为了写出灵活且简洁的代码，我们需要克制住展现小技巧的欲望。相较于通过设计自上而下地获取灵活性，从确保简洁出发，通过单元测试自下而上地获取灵活性会更好。

> 代码必然会被修改

## 背后的原理

### 效应局部化

效应局部化中的“效应”是指修改带来的影响。

效应局部化是指将修改带来的影响控制在局部。

效应局部化是一个很重要的原则。围绕该原则产生了许多技术，模块化就是其中之一。模块化技术的目标之一就是让修改模块所带来的影响停留在该模块的内部。

**How：**

在编写代码时，要让关系紧密的代码集中在一起，同时保证关联性较弱的代码不互相依赖。为此，我们需要将关系紧密的代码集中起来实现模块化。

从关联性的角度来看，我们要格外注意相互频繁调用的模块。模块之间相互频繁调用通常表明原本应该放在一起的要素被分别放在了不同的模块中。

这种时候就需要让合适的单一模块来实现功能，或者将模块功能整合在一起，或者重新创建一个模块来实现相应的功能，总之要保证单一功能的密集性。

> 在效应局部化的情况下，我们需要阅读的代码以及修改所带来的影响都会限制在一定的范围内。

### 重复最小化

重复最少化，就是指极力消除重复。

许多技术都以实现重复最少化为目标，函数化技术就是其中之一。该技术将重复的逻辑函数化，整合成一段共享代码来使用。

**How:**

我们要将代码分割成多个小块。

大块代码之间一般会存在重复的部分。将大块代码分割成多个小块之后，就能轻松找出共同的部分了。

将代码分割成多个小块后，要明确代码内哪些地方是完全一样的，哪些地方是相似的，哪些地方是完全不同的。只要区分清楚这些，代码的可读性就会提高，修改成本也会下降。

> 重复违反了效应局部化原则。

### 逻辑与数据的一体化

逻辑与数据的一体化是指把逻辑和该逻辑处理的数据放在相近的位置。

所谓相近的位置，指的是在同一函数或同一模块内。距离越近，代码的质量就越高。

**How:**

我们要把数据与逻辑放在相近的位置。

不过，我们很难一开始就知道哪个逻辑应该和哪些数据放在一起。这时不妨先大致安排一下，之后再根据具体情况进行调整。

编写、运行代码之后，数据与逻辑的关联性会渐渐显露出来。是让代码靠近数据，还是让数据靠近代码；是将代码和数据取出来放到其他位置，还是不进行任何变动……对于这些问题，我们会在不断尝试的过程中逐渐了解具体的做法。

> 修改代码时往往需要同时修改逻辑与该逻辑处理的数据。因此，如果把二者放在同一位置，我们要阅读的代码就会减少，修改也不会波及其他元素。从结果来看，这么做降低了修改成本。

### 声明式编程

声明式表达是指在表达代码意图时，尽量用“声明式”的表达方式，而非“命令式”的表达方式。

命令式编程描述的是问题的解决方法，也就是数据结构与算法。而声明式编程描述的是问题的定义，也就是当前问题的性质及解决问题时应满足的限制条件。

**How:**

我们要采用声明式的表达方式，简洁地表达意图。

当编程范式使用了声明式语言时，由于编写出的代码是声明式的，所以不用我们去特别注意什么。

另一方面，当编程范式使用了命令式语言时，我们也要在代码中合适的部分使用声明式表达，以获取声明式带来的优势。

### 变动率

变动率体现了修改代码的时间点，变动率相同意味着代码在同一时间点被修改。同时修改的元素要放在同一个地方，在不同时间点修改的元素要放在不同的地方。

**How:**

修改时间相同的元素要放在同一个地方，修改时间不同的元素要放在不同的地方。这对逻辑和数据来说都适用。

> - 如果模块只存在一个修改理由，就代表该模块由关联性极强的代码集合而成。这类模块满足高聚合性，非常牢固
> - 单一职责原则

### 对称原理

对称原理就是讲究形式上的对称，比如有上就有下，有左就有右，有主动就有被动。

也就是说，我们在思考一个处理时，也要想到与之成对的处理。比如有给标志位置1的处理，就要有给标志位置0的处理。

**How:**

编写有对称性的代码。

在出现“条件”的时候，我们要注意它的“反条件”。每个控制条件都存在与之成对的反条件（与指示条件相反的条件）。要注意条件与反条件的统一，保证控制条件具有统一性。

我们还要考虑到例外情况并极力避免其发生。例外情况的特殊性会破坏对称性，成为故障的温床。特殊情况过多意味着需求没有得到整理。此时应重新审视需求，尽量从代码中剔除例外情况。

命名也要讲究对称性。命名时建议使用set/get、start/stop、begin/end和push/pop等成对的词语。

> - 具有对称性的代码能够帮助读代码的人推测后面的代码，提高其理解代码的速度。同时，对称性会给代码带来美感，这同样有助于他人理解代码。
> - 设计代码时将对称性纳入考虑的范围能防止我们在思考问题时出现遗漏。
> - 在代码中明确表现出对称性后，代码的可读性将大幅提高。

### 简单性原理

简单性原理就是追求简单。

说得极端一点，就是自始至终都以最简单的逻辑编写代码，让编程初学者一眼就能看懂。

因此，在编程时我们要重视的是局部的完整性，而不是复杂的整体关联性。

**How:**

编写自然的代码。

努力写出自然的代码。放下高超的技巧，坚持用简单的逻辑编写代码。

既然故障集中在代码复杂的区域，那我们只要让代码简单到让故障无处可藏即可。不要盲目地让代码复杂化、臃肿化，要保证代码简洁。

> bug喜欢出现在复杂的地方。
> 简单易懂的代码往往给人一种不够专业的感觉。这也是经验老到的程序员喜欢写老练高深的代码的原因。所以我们要有足够的定力来抵挡这种诱惑。

### 同构原理

同构原理就是力求规范。

同等对待相同的东西，坚持不搞特殊。同等对待，举例来说就是同一个模块管理的数值全部采用同一单位、公有函数的参数个数统一等。

**How:**

编写符合规范的代码。

我们要让代码符合一定的规范。不过，这会与程序员的自我表现欲相冲突。

为了展现自己的实力，有些程序员会无视编程规范，编写独特的代码。可靠与简单是代码不可或缺的性质，但这些程序员常常在无意间让代码变得复杂。

这就把智慧与个性用错了地方。小小的自我满足远不及代码质量重要。所以在编写代码时，务必克制住自己的表现欲，以规范为先。

### 层次原理

层次原理就是在结构上讲究层次。

注意事物的主从关系、前后关系和本末关系等层次关系，整理事物的关联性。

不同层次各司其职，同种处理不跨越多个层次，这一点非常重要。比如执行了获取资源的处理，那么释放资源的处理就要在相同的层次进行。又比如互斥控制的标志位置1和置0的处理要在同一层次进行。

**How:**

在编写代码时设计各部分的抽象程度，构建层次结构。保证同一个层次中的所有代码抽象程度相同。

另外，高层次的代码要通过外部视角描述低层次的代码。这样做能让调用低层次代码的高层次代码更加简单易懂。

> 有明确层次结构的代码能帮助读代码的人抽象理解代码的整体结构。读代码的人可以根据自身需要阅读下一层次的代码，掌握更加详细的信息。

### 线性原理（透明原理）

线性原理就是让处理流程尽量走直线。

一个功能如果可以通过多个功能的线性结合来实现，那它的结构就会非常简单。

反过来，用条件分支控制代码、毫无章法地增加状态数等行为会让代码变得难以理解。我们要避免做出这些行为，提高代码的可读性。

“透明”一词可以用来形容代码有较高的可读性，所以线性原理又称为“透明原理”。

**How:**

尽量减少条件分支的数量，编写能让代码阅读者线性地看完整个处理流程的代码。

为此，我们需要把一些特殊的处理拿到主处理之外。保证处理的统一性，注意处理的流程。记得时不时俯瞰代码整体，检查代码是否存在过于复杂的部分。

另外，对于经过长期维护而变得过于复杂的部分，我们可以考虑对其进行重构。明确且可靠的设计不仅对我们自身有益，还可以给负责维护的人带来方便。

> 复杂的处理流程是故障的温床。

### 清晰原理

清晰原理就是注意逻辑的清晰性。

逻辑具有清晰性就代表逻辑能清楚证明自身的正确性。也就是说，我们编写的代码要让人一眼就能判断出没有问题。任何不明确的部分都要附有说明。

保证逻辑的清晰性要“不择手段”。在无法用代码证明逻辑正确性的情况下，我们也可以通过写注释、附文档或画图等方法来证明。不过，证明逻辑的正确性是一件麻烦的事，时间一长，人们就会懒得用辅助手段去证明，转而编写逻辑清晰的代码了。

**How:**

我们要编写逻辑清晰的代码。

为此，我们应选用直观易懂的逻辑。会给读代码的人带来疑问的部分要么消除，要么加以注释。

另外，我们应使用任何人都能立刻理解且不存在歧义的术语。要特别注意变量名等一定不能没有意义。

> - 重复使用代码的风险
> - 修复代码故障的风险

### 安全原理

安全原理就是注意安全性，采用相对安全的方法来对具有不确定性的、模糊的部分进行设计和编程。

说得具体一点，就是在编写代码时刻意将不可能的条件考虑进去。比如即便某个if语句一定成立，我们也要考虑else语句的情况；即便某个case语句一定成立，我们也要考虑default语句的情况；即便某个变量不可能为空，我们也要检查该变量是否为NULL。

**How:**

编写安全的代码。

选择相对安全的方法对具有不确定性的部分进行设计。列出所有可能的运行情况，确保软件在每种情况下都能安全运行。理解需求和功能，将各种情况正确分解到代码中，这样能有效提高软件安全运行的概率。

为此，我们也要将不可能的条件视为考察对象，对其进行设计和编程。不过，为了统一标准，我们在编写代码前最好规定哪些条件需要写，哪些条件不需要写。

> - 防止故障发展成重大事故
> - 对代码的实现来说，需求和功能的说明书只能算必要条件。
> - 安全性是满足充分条件必不可少的要素。我们要让代码在满足必要条件的同时准确涵盖各种功能和情况，在与用户保持沟通的过程中，让每个实例都坚实可靠。
