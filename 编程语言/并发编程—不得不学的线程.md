# 并发编程——不得不学的线程

> :pencil2: 不要试图去做一个成功的人，要努力成为一个有价值的人。——爱因斯坦

## 进程

### 概念

进程（Process）是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。在早期面向进程设计的计算机结构中，进程是程序的基本执行实体；在当代面向线程设计的计算机结构中，进程是线程的容器。程序是指令、数据及其组织形式的描述，进程是程序的实体。

简单来说，进程是程序的一次启动执行。什么是程序呢？程序是存放在硬盘中的可执行文件，主要包括代码指令和数据。一个进程是一个程序的一次启动和执行，是操作系统将程序装入内存，给程序分配必要的系统资源，并且开始运行程序的指令。

> [!note|label:进程与程序的关系]
>
> 同一个程序可以多次启动，对应多个进程。

### 进程的组成

一般来说，一个进程由程序段、数据段和进程抗旨块三部分组成。大致结构如图。

![进程的结构](../img/编程语言/进程的结构.png)

- 程序段：也称为代码段，代码段是进程的程序指令在内存中的位置，包含需要执行的指令集合
- 数据段：进程的操作数据在内存中的位置，包含需要操作的数据集合
- 程序控制块(PCB)：进程的描述信息和控制信息，是进程存在的唯一标志

----

`PCB`主要由四大部分组成：

- 进程的描述信息
  - 进程ID和进程名称，进程ID是唯一的，代表进程的身份
  - 进程状态，比如运行、就绪、阻塞；进程优先级，是进程调度的重要依据
- 进程的调度信息
  - 程序起始地址，程序的第一行指令的内存地址，从这里开始程序的执行
  - 通信信息，进程间通信时的消息队列
- 进程的资源信息
  - 内存信息，内存占用情况和内存管理所用的数据结构
  - I/O设备信息，所用的I/O设备编号及相应的数据结构
  - 文件句柄，所打开文件的信息
- 进程上下文
  - 执行时各种CPU寄存器的值
  - 当前程序计数器(PC)的值
  - 各种栈的值

!> 进程的上下文就是进程的环境，当前进程被迫让出CPU，当前进程的上下文就保存在PCB结构种，供下次恢复运行时使用

### 从JVM看进程

Java编写的程序都运行在Java虚拟机（JVM）中，每当使用Java命令启动一个Java应用程序时，就会启动一个JVM进程。

在这个JVM进程内部，所有Java程序代码都是以线程来运行的。JVM找到程序的入口点`main()`方法，然后运行`main()`方法，这样就产生了一个线程，这个线程被称为主线程。当`main()`方法结束后，主线程运行完成，JVM进程也随即退出。

## 线程

### 概念

线程是指“进程代码段”的一次顺序执行流程。线程是CPU调度的最小单位。一个进程可以有一个或多个线程，各个线程之间共享进程的内存空间、系统资源，进程仍然是操作系统资源分配的最小单位。

### 线程的组成

一个线程主要有三部分组成，主要有线程描述信息、程序计数器(PC)、和栈内存。

![进程的结构](../img/编程语言/线程的结构.png)

- 线程描述信息，也是线程的基本信息
  - 线程ID(Thread ID，线程标识符)：线程的唯一标识，同一个进程内的不同线程的ID不会重叠
  - 线程名称：主要是方便用户识别，用户可以指定线程的名字，如果没有指定，系统就会自动分配一个名称
  - 线程优先级：表示线程调度的优先级，优先级越高，获得CPU的执行机会就越大
  - 线程状态：表示当前线程的执行状态，为新建、就绪、运行、阻塞、结束等状态中的一种
- 程序计数器：记录着线程下一条指令的代码段内存地址
- 栈内存：代码段中局部变量的存储空间，为线程所独立拥有，在线程之间不共享

## 进程与线程的区别

- 线程是“进程代码段”的一次顺序执行流程，一个进程由一个或多个线程组成，一个进程至少有一个线程
- 线程是CPU调度的最小单位，进程是操作系统分配资源的最小单位。线程的划分尺度小于进程，使得多线程程序的并发性高
- 线程是出于高并发的调度诉求从进程的内部演进而来的。线程的出现既充分发挥了CPU的计算性能，又弥补了进度调度笨重的问题
- 进程之间是否相互独立的，但进程内部的各个线程之间并不完全独立。各个线程之间共享进程的方法区内存、堆内存、系统资源（文件句柄、系统信号等）
- 切换速度不同：线程上下文切换比进程上下文切换要快得多，因此，线程也被称之为轻量级进程
