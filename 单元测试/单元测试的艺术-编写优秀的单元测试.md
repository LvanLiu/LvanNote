# 编写优秀的单元测试

> [!ATTENTION]
> 无论如何组织测试、无论有多少测试、如果你不能信任、维护以及阅读它们，这些测试几乎没有价值。

*优秀的测试的特性：**

- 可靠性：测试结果可靠，开发人员对此有信心
- 可维护性：无法维护的单元测试就是恶梦
- 可读性：单元测试失去可读性，就失去了可靠性以及可维护性

## 单元测试的原则和技术

### 决定何时删除或修改测试

>[!NOTE]
> 单元测试是被测试代码的保护伞，如果单元测试通过，你通常不应该删除或修改这些测试。

导致单元测试被删除或者被修改，有可能是以下原因造成的。

**产品缺陷**

产品缺陷：如果你修改了产品的代码，导致已有的一个测试失败，这就出现了一个产品缺陷。
解决方案：修复产品的缺陷，并通过单元测试（一般不需要修改单元测试，因为单元测试是完好的）。

**测试缺陷**

测试缺陷：测试代码中存在缺陷，但是一般开发人员不会直接定位到或者认为测试代码存在缺陷，需要经过一定的过程，才能发现这类问题。
解决方案：修改测试代码中的缺陷，并确保测试应该失败时失败，应该成功时成功。

**语义或者Api变更**

语义变更：被测试的产品代码产生变更导致测试失败，可能是因为测试对象的功能虽然没有改变，但是使用方式产生了变更。
解决方案：修改测试代码，以符合语义。

**冲突或者无效的测试**

冲突/无效的测试：如果产品代码引入一个新功能，和一个测试有直接冲突，那这个就是冲突测试。这种情况说明测试是没有问题的，但是发现了冲突的产品需求。
解决方案：首先应该确认这些测试是冲突的，一旦确认，你需要决定保留哪个需求。然后，你应该删除无效的需求和测试

> [!NOTE]
> 有时候，冲突的测试可以发现客户需求中的问题，客户可能需要决定各个需求是否有效

**重命名或者重构测试**

重命名/重构测试：不可读的测试代码带来的麻烦比解决的问题还要多，它会影响代码的可读性，妨碍你理解测试和发现问题的进度。
解决方案：修改测试代码，但是不改变测试代码的基本功能。

**删除重复的测试**

重复测试：在开发的团队中，经常会出现不同的开发者编写了多个测试，测试同一个功能的情况。
解决方案：重复的测试，可能是针对不用的语义进行测试，测试越多，就越可能发现越多缺陷。但是重复的测试也带来难维护、测试分散的问题，因此一般都会删除这些重复的测试，因为它带来的缺点超过了它带来的优点。

**避免测试中的逻辑**

避免测试逻辑：测试中出现逻辑，会导致出现测试缺陷的几率成倍的增加，如果单元测试包括了条件/循环等代码，就可以认为出现了测试逻辑。
解决方案：通过代码审查发现，开发人员要避免往测试中加逻辑。

**只测试一个关注点**

只测一个关注点：一个关注点是一个工作单元的一个最终结果：一个返回值、系统状态的一个改变或者对第三方对象的一个调用。如果一个单元测试对多个对象进行了断言，那么这个测试就可能测试了多个关注点。
解决方案：每个单元测试关注点保持一个。

**单元测试与集成测试拆分**

可以参考[单元测试的艺术-编写优秀的单元测试](./单元测试的艺术-编写优秀的单元测试.md)

**用代码审查确保代码覆盖率**

可利用三方工具来进行代码覆盖率检查，若代码覆盖率太低，说明单元测试做的比较少，很容易造成产品缺陷。
