# 单元测试的艺术阅读笔记

## 单元测试基础

### 什么是单元测试

一个单元测试是一段自动化的代码，这段代码调用被测试的工作单元，之后对这个单元的单个最终结果的某些假设进行检验。单元测试几乎都是单元测试框架编写的。单元测试容易编写，能快速运行。单元测试可靠、刻读，并且可维护。只要产品不发生变化，单元测试的结果是稳定的。

### 什么是集成测试

任何测试，如果它运行速度不快，结果不稳定，或者要用到被测试单元的一个或多个真实依赖物，我就认为它是集成测试。例如，如果一个测试要使用真实的系统时间，真实的文件系统或者一个真实的数据库，那这个测试就进入了集成测试的领域。

集成测试也与单元测试同等重要，但是还是要将它们拆分开，如果只做集成测试，不做单元测试，是比较难定位问题的。

### 优秀的单元测试

优秀的单元测试具有以下特性：

- 它应该是自动化的，可重复执行
- 它应该很容易实现
- 它应该第二天还有意义
- 任何人都应该一键运行它
- 它应该运行速度很快
- 它的结果应该是稳定的（如果运行之间没有进行修改的话，多次运行的一个测试应该总是返回同样的结果）
- 它应该能完全控制被测试的单元
- 它应该是完全隔离的（独立于其他测试的运行）
- 如果它失败了，我们应该很容易发现什么是期待的结果，进而定位问题的所在

## 第一个单元测试

### 编写一个单元测试需要考虑的点

编写的单元测试，程序员需要想出完善的测试策略来覆盖所有情况，如下：

- 使用断言
- 不止考虑反校验，还是添加正校验
- 从红到绿：以一个失败的测试开始，然后使这个测试通过，然后修改代码使其可读，更易维护
- 正确的测试方法命名
- 测试方法中，准备对象、操作对象以及断言阶段的代码之间都要空出一行
- Junit5参数化测试
- 检验预期的异常避免使用expect注解去校验，应使用Assert类中的方法去校验
- 对于存在错误的测试代码，但又将这些代码签入到master分支了，可以给这些代码添加Ignore属性
- 测试系统状态的改变而非返回值

单元测试的命名规范：

- 命名模板：工作单元_设想_期待行为
- 如果没有前置动作而有一个预期的返回值，可以用byDefault
- 对于一些工作单元（改变状态或者调用第三方系统），如果不需要进行前期配置，系统状态改变或第三方调用已经完成，可以用WhenCalled或Always

## 核心技术

### 使用存根破除依赖

**外部依赖项**

定义：一个外部依赖项是系统中的一个对象，被测试代码与这个对象发生交互，但你不能控制这个对象。（常见的外部依赖项包括文件系统、线程、内存以及时间等）。

**存根**

定义：一个存根是对系统中存在的一个依赖项（或者协作者）的可控制的替代物。通过使用存根，你在测试代码时无需直接处理这个依赖项。

在测试代码中，我们可以使用**存根**来回避外部依赖项的问题。

> [!tip]
> 模拟对象和存根很类似，但是你会模拟对象进行断言，而不会对存根进行断言。

