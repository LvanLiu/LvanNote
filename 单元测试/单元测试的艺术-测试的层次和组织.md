# 单元测试的艺术-测试的组织和层次

## 运行自动化测试的自动化构建

自动化构建流程的可以使团队更敏捷、效率更高、更快得到反馈，如果计划往这方面发展，需要考虑以下要点：

- 对代码做小的修改
- 运行所有的测试，确保现有功能没有被破坏
- 确保代码依然能够很好地集成，不会破坏你依赖的任何其他项目
- 创建代码交付包，一键自动部署

完成以上任务，需要配备**构建配置**以及**构建脚本**。构建脚本是一段的脚本，和代码一起放在源代码管理系统中，构建脚本能够知道当前版本，因为它们和你的产品源代码一样受版本管理的。持续集成服务器的构建配置会调用这些脚本。

> [!TIP]
> 现在一般都是利用Dockerfile来作为构建脚本，结合Jenkins持续集成服务器，可以实现自动化部署以及运行所有的单元测试，

## 构建脚本结构

一般使用的构建脚本分为以下三类：

- 持续集成（CI）构建脚本：它至少要构建当前代码的调试版本，还要运行所有的单元测试。它的目标是**为了在最短的时间内得到最多的信息，脚本运行时间越短，你就越能越快知道代码没有问题。**
- 每日构建脚本：它通常需要较长的时间，有些任务和持续集成无关的，或者不重要的，没有包括在快速持续集成这个快速反馈周期里，这些任务就由每日构建来完成。虽称之为每日构建脚本，但是一天是可以运行多次的。
- 部署构建脚本：它的本质是一个**交付机制**，部署构建脚本由持续集成服务器触发执行。

## 基于速度和类型布局测试

> [!ATTENTION]
> 通过运行测试，检查它们的运行时间，很容易就能区分哪些是**集成测试**、哪些是**单元测试**。

在平时的开发中，我们应该将集成测试与单元测试分开存放。因为如果不分开存放，开发人员通常认为配置问题导致的失败，或者其他跟集成测试相关的问题，它们会觉得这些问题不重要而直接忽略。

## 绿色安全区

通过把集成测试与单元测试分开放置，两种测试分开，就给团队中的开发人员创建了一个绿色安全测试区。

**绿色安全区**只包含单元测试的代码，运行绿色安全区里的单元测试，结果应该是绿色的。如果有绿色安全区域里的测试失败，就说明出现了真正的代码问题，不是测试中的配置问题导致的假警报。

> [!ATTENTION]
> 1. 集成测试应该存放到每日构建脚本中。或者将集成测试的代码存放到集成区，开发人员可以根据其需求进行测试。
> 2. 对于一个应用程序而言，单元测试和产品源代码同等重要。 像对待常规代码一样，你需要咨仔细考虑相对于被测试的代码。

## 将测试类映射到被测试的代码

遵循**测试类映射到被测试的代码原则**，会带来以下好处：

- 找到一个项目的所有相关测试
- 找到一个类的所有相关测试
- 找到一个方法的所有相关测试

**将测试映射到项目**

类比Springboot项目，它创建了src/main/test下的项目目录，用于存放所有的单元测试的代码，而且test目录下的包命名以及排版均与src/main/java目录下的一致，这就很容易根据测试类代码所在的包找到其对应被测试代码所在的包。

**将测试映射到类**

将测试映射到测试类，最主要的两种是：

- 给每个被测试类创建一个测试类：在测试的项目中，创建一个测试类，用被测试类的名字加上Test后缀命名。
- 给每个被测试的复杂方法创建一个单独的测试类：如果一个方法比较复杂，从而造成它的测试用例比较多，那么就要为这个方法创建一个测试类。

**将测试映射到具体的工作单元入口**

除了保证测试名可读容易理解，对于具体的被测试工作单元，人们还希望能够很容易地找到所有相关的测试方法，因此测试方法的命名应该有意义。你可以在命名时，包含被测试工作单元的入口方法名。